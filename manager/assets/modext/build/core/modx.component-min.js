MODx.Component=function(A){A=A||{};MODx.Component.superclass.constructor.call(this,A);this.config=A;this._loadForm();if(this.config.tabs){this._loadTabs();}this._loadComponents();this._loadActionButtons();MODx.activePage=this;};Ext.extend(MODx.Component,Ext.Component,{fields:{},form:null,action:false,_loadForm:function(){if(!this.config.form){return false;}this.form=new Ext.form.BasicForm(Ext.get(this.config.form),{errorReader:MODx.util.JSONReader});if(this.config.fields){for(var A in this.config.fields){if(this.config.fields.hasOwnProperty(A)){var B=this.config.fields[A];if(B.xtype){B=Ext.ComponentMgr.create(B);}this.fields[A]=B;this.form.add(B);}}}return this.form.render();},_loadActionButtons:function(){if(!this.config.buttons){return false;}this.ab=MODx.load({xtype:"modx-actionbuttons",form:this.form||null,formpanel:this.config.formpanel||null,actions:this.config.actions||null,items:this.config.buttons||[],loadStay:this.config.loadStay||false});return this.ab;},_loadTabs:function(){if(!this.config.tabs){return false;}var A=this.config.tabOptions||{};Ext.applyIf(A,{xtype:"modx-tabs",renderTo:this.config.tabs_div||"tabs_div",items:this.config.tabs});return MODx.load(A);},_loadComponents:function(){if(!this.config.components){return false;}var B=this.config.components.length;var D=Ext.getCmp("modx-content");for(var C=0;C<B;C=C+1){var A=MODx.load(this.config.components[C]);if(D){D.add(A);}}if(D){D.doLayout();}return true;},submitForm:function(D,B,A){D=D||{};A=A||{};if(!this.config.formpanel||!this.config.action){return false;}f=Ext.getCmp(this.config.formpanel);if(!f){return false;}for(var C in D){if(typeof D[C]=="function"){f.on(C,D[C],this);}else{if(D[C]&&typeof D[C]=="object"&&D[C].fn){f.on(C,D[C].fn,D[C].scope||this);}}}Ext.apply(f.baseParams,{action:this.config.action});Ext.apply(f.baseParams,A);B=B||{};B.headers={"Powered-By":"MODx",modAuth:MODx.siteId};f.submit(B);return true;}});Ext.reg("modx-component",MODx.Component);MODx.toolbar.ActionButtons=function(A){A=A||{};Ext.applyIf(A,{actions:{close:MODx.action.welcome},formpanel:false,id:"modx-action-buttons",loadStay:false,params:{},items:[],renderTo:"modAB"});if(A.formpanel){this.setupDirtyButtons(A.formpanel);}if(A.loadStay===true){A.items.push("-",this.getStayMenu());}MODx.toolbar.ActionButtons.superclass.constructor.call(this,A);this.config=A;};Ext.extend(MODx.toolbar.ActionButtons,Ext.Toolbar,{id:"",buttons:[],options:{a_close:"welcome"},stay:"stay",checkDirtyBtns:[],add:function(){var J=arguments,D=J.length;for(var F=0;F<D;F++){var C=J[F];var G=["-","->","<-",""," "];if(G.indexOf(C)!=-1||(C.xtype&&C.xtype=="switch")){MODx.toolbar.ActionButtons.superclass.add.call(this,C);continue;}var B=C.id||Ext.id();Ext.applyIf(C,{xtype:"button",cls:(C.icon?"x-btn-icon bmenu":"x-btn-text bmenu"),scope:this,disabled:C.checkDirty?true:false,listeners:{},id:B});if(C.button){MODx.toolbar.ActionButtons.superclass.add.call(this,C);}if(C.handler===null&&C.menu===null){C.handler=this.checkConfirm;}else{if(C.confirm&&C.handler){C.handler=function(){Ext.Msg.confirm(_("warning"),C.confirm,function(K){if(K==="yes"){Ext.callback(C.handler,this);}},C.scope||this);};}else{if(C.handler){}else{C.handler=this.handleClick;}}}if(C.javascript){C.listeners.click={fn:this.evalJS,scope:this};}if(C.xtype=="button"){C.listeners.render={fn:function(K){if(C.checkDirty&&K){this.checkDirtyBtns.push(K);}},scope:this};}MODx.toolbar.ActionButtons.superclass.add.call(this,C);if(C.keys){var A=new Ext.KeyMap(Ext.get(document));var H=C.keys.length;for(var I=0;I<H;I=I+1){var E=C.keys[I];Ext.applyIf(E,{scope:this,stopEvent:true,fn:function(L){var K=Ext.getCmp(B);if(K){this.checkConfirm(K,L);}}});A.addBinding(E);}}delete C;}},evalJS:function(itm,e){if(!eval(itm.javascript)){e.stopEvent();e.preventDefault();}},checkConfirm:function(B,A){if(B.confirm!==null&&B.confirm!==undefined){this.confirm(B,function(){this.handleClick(B,A);},this);}else{this.handleClick(B,A);}return false;},confirm:function(C,B,A){if(C.confirm===null){return true;}Ext.Msg.confirm("",C.confirm,function(D){if(D==="yes"){if(B===null){return true;}if(typeof (B)==="function"){Ext.callback(B,A||this,[C]);}else{location.href=B;}}return true;},this);return true;},reloadPage:function(){location.href=location.href;},handleClick:function(G,D){var E=this.config;if(E.formpanel===false||E.formpanel===undefined||E.formpanel===null){return false;}if(G.method==="remote"){MODx.util.Progress.reset();E.form=Ext.getCmp(E.formpanel);if(!E.form){return false;}var C=E.form.getForm?E.form.getForm():E.form;var F=true;if(C.items&&C.items.items){for(var B in C.items.items){if(C.items.items[B]&&C.items.items[B].validate){var A=C.items.items[B].validate();if(!A){C.items.items[B].markInvalid();F=false;}}}}if(F){Ext.applyIf(E.params,{action:G.process,"modx-ab-stay":MODx.config.stay});Ext.apply(C.baseParams,E.params);E.form.on("success",function(H){if(E.form.clearDirty){E.form.clearDirty();}MODx.msg.status({title:_("success"),message:_("save_successful"),dontHide:H.result.message!=""?true:false});Ext.callback(this.redirectStay,this,[E,G,H.result],1000);},this);E.form.submit({headers:{"Powered-By":"MODx",modAuth:MODx.siteId}});}else{Ext.Msg.alert(_("error"),_("correct_errors"));}}else{Ext.applyIf(G.params||{},E.baseParams||{});location.href="?"+Ext.urlEncode(G.params);}return false;},checkStay:function(B,A){this.stay=B.value;},redirectStay:function(E,F,D){E=this.config;F.params=F.params||{};Ext.applyIf(F.params,E.baseParams);var A=Ext.state.Manager.get("modx.stay."+MODx.request.a,"stay");switch(A){case"new":if(E.form.hasListener("actionNew")){E.form.fireEvent("actionNew",F.params);}else{if(E.actions){if(MODx.request.parent){F.params.parent=MODx.request.parent;}if(MODx.request.context_key){F.params.context_key=MODx.request.context_key;}var B=Ext.urlEncode(F.params);location.href="?a="+E.actions["new"]+"&"+B;}}break;case"stay":var C;if(E.form.hasListener("actionContinue")){E.form.fireEvent("actionContinue",F.params);}else{if(E.actions){if((F.process==="create"||F.process==="duplicate"||F.reload)&&D.object.id!==null){F.params.id=D.object.id;if(MODx.request.parent){F.params.parent=MODx.request.parent;}if(MODx.request.context_key){F.params.context_key=MODx.request.context_key;}C=Ext.urlEncode(F.params);location.href="?a="+E.actions.edit+"&"+C;}else{if(F.process==="delete"){F.params.a=E.actions.cancel;C=Ext.urlEncode(F.params);location.href="?"+C;}}}}break;case"close":if(E.form.hasListener("actionClose")){E.form.fireEvent("actionClose",F.params);}else{if(E.actions){location.href="?a="+E.actions.cancel+"&"+Ext.encode(F.params);}}break;}},getStayMenu:function(){var A=Ext.state.Manager.get("modx.stay."+MODx.request.a,"stay");var B=0;switch(A){case"new":B=0;break;case"close":B=2;break;case"stay":default:B=1;break;}return{xtype:"switch",id:"modx-stay-menu",activeItem:B,items:[{tooltip:_("stay_new"),value:"new",menuIndex:0,id:"modx-stay-new",iconCls:"icon-list-new"},{tooltip:_("stay"),value:"stay",menuIndex:1,id:"modx-stay-stay",iconCls:"icon-mark-active"},{tooltip:_("close"),value:"close",menuIndex:2,id:"modx-stay-close",iconCls:"icon-mark-complete"}],listeners:{change:function(C,D){Ext.state.Manager.set("modx.stay."+MODx.request.a,D.value);},scope:this,delay:10}};},refreshTreeNode:function(A,D,B){var C=parent.Ext.getCmp(A);C.refreshNode(D,B||false);return false;},setupDirtyButtons:function(B){var A=Ext.getCmp(B);if(A){A.on("fieldChange",function(E){for(var D=0;D<this.checkDirtyBtns.length;D=D+1){var C=this.checkDirtyBtns[D];C.setDisabled(false);}},this);}}});Ext.reg("modx-actionbuttons",MODx.toolbar.ActionButtons);