MODx.grid.Package=function(A){A=A||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="package-readme"><i>{readme}</i></p>')});this.action=new Ext.ux.grid.RowActions({actions:[{iconIndex:"iconaction",textIndex:"textaction"}],widthSlope:125});this.action.on("action",function(F,E,D,C){this.menu.record=E.data;switch(D){case"icon-install":this.install(this.action,{});break;case"icon-uninstall":this.uninstall(this.action,{});break;}},this);var B=[];B.push(this.exp);B.push({header:_("name"),dataIndex:"name"});B.push({header:_("version"),dataIndex:"version"});B.push({header:_("release"),dataIndex:"release"});B.push({header:_("installed"),dataIndex:"installed",renderer:this._rins});if(MODx.config.auto_check_pkg_updates==1){B.push({header:_("updateable"),dataIndex:"updateable",renderer:this.rendUpdateAvail});}B.push({header:_("provider"),dataIndex:"provider_name"});B.push(this.action);Ext.applyIf(A,{title:_("packages"),id:"modx-grid-package",url:MODx.config.connectors_url+"workspace/packages.php",fields:["signature","name","version","release","created","updated","installed","state","workspace","provider","provider_name","disabled","source","attributes","readme","menu","install","textaction","iconaction","updateable"],plugins:[this.action,this.exp],pageSize:10,columns:B,primaryKey:"signature",paging:true,autosave:true,tbar:[{text:_("package_add"),handler:this.loadPackageDownloader},{text:_("download_extras"),handler:this.loadMainProvider}],tools:[{id:"plus",qtip:_("expand_all"),handler:this.expandAll,scope:this},{id:"minus",hidden:true,qtip:_("collapse_all"),handler:this.collapseAll,scope:this}]});MODx.grid.Package.superclass.constructor.call(this,A);this.on("render",function(){this.getView().mainBody.update('<div class="x-grid-empty">'+_("loading")+"</div>");},this);};Ext.extend(MODx.grid.Package,MODx.grid.Grid,{console:null,loadPackageDownloader:function(B,C){var A="modx-window-package-downloader";if(!this.windows[A]){this.windows[A]=MODx.load({xtype:A});}this.windows[A].config.firstPanel="modx-pd-start";this.windows[A].config.showFirstPanel=true;this.windows[A].show(C.target);},loadMainProvider:function(B,C){var A="modx-window-package-downloader";if(!this.windows[A]){this.windows[A]=MODx.load({xtype:A,showFirstPanel:false});}this.windows[A].show(C.target,function(){var F=Ext.getCmp("modx-window-package-downloader");F.fireEvent("proceed","modx-pd-selpackage");Ext.getCmp("modx-package-browser-thumb-view").hide();Ext.getCmp("modx-package-browser-grid-panel").hide();Ext.getCmp("modx-package-browser-view").show();var G=Ext.getCmp("modx-package-browser-tree");if(G){G.getLoader().baseParams.provider=MODx.provider;G.refresh();G.renderProviderInfo();G.getRootNode().setText(MODx.providerName);}var H=Ext.getCmp("modx-package-browser-grid");if(H){H.getStore().baseParams.provider=MODx.provider;H.getStore().removeAll();}var E=Ext.getCmp("modx-package-browser-thumbs-view");if(E){E.baseParams.provider=MODx.provider;}F.syncSize();F.doLayout();if(Ext.isIE){F.setHeight("400px");}else{var D=F.getBottomToolbar();if(D){D.getComponent("btn-next").setText(_("finish"));D.getComponent("btn-back").setDisabled(true);}}try{var J=F.el.getAlignToXY(F.container,"c-c");if(J){F.setPagePosition(J[0],0);}}catch(I){}},this);},viewPackage:function(A,B){location.href="index.php?a="+MODx.action["workspaces/package/view"]+"&signature="+this.menu.record.signature;},update:function(A,B){MODx.Ajax.request({url:this.config.url,params:{action:"update-remote",signature:this.menu.record.signature},listeners:{success:{fn:function(C){this.loadWindow(A,B,{xtype:"modx-window-package-update",packages:C.object,record:this.menu.record,force:true,listeners:{success:{fn:function(D){this.refresh();this.menu.record=D.a.result.object;this.install(A,B);},scope:this}}});},scope:this},failure:{fn:function(C){MODx.msg.alert(_("package_update"),_("package_err_uptodate",{signature:this.menu.record.signature}));return false;},scope:this}}});},_rins:function(A,B){switch(A){case"":case null:B.css="not-installed";return _("not_installed");default:B.css="";return A;}},loadConsole:function(B,A){if(this.console===null){this.console=MODx.load({xtype:"modx-console",register:"mgr",topic:A});}else{this.console.setRegister("mgr",A);}this.console.show(B);},getConsole:function(){return this.console;},uninstall:function(A,B){this.loadWindow(A,B,{xtype:"modx-window-package-uninstall",listeners:{success:{fn:function(C){this._uninstall(this.menu.record,C,A);},scope:this}}});},_uninstall:function(D,C,B){var D=this.menu.record;C=C||{};var A="/workspace/package/uninstall/"+D.signature+"/";this.loadConsole(B,A);Ext.apply(C,{action:"uninstall",signature:D.signature,register:"mgr",topic:A});MODx.Ajax.request({url:this.config.url,params:C,listeners:{success:{fn:function(E){Ext.Msg.hide();this.refresh();Ext.getCmp("modx-layout").refreshTrees();},scope:this},failure:{fn:function(E){Ext.Msg.hide();this.refresh();},scope:this}}});},remove:function(B,D){var C=this.menu.record;var A="/workspace/package/remove/"+C.signature+"/";this.loadWindow(B,D,{xtype:"modx-window-package-remove",record:{signature:C.signature,topic:A,register:"mgr"}});},install:function(A,C,B){this.loadWindow(A,C,{xtype:"modx-window-package-installer",listeners:{finish:{fn:function(D){this._install(this.menu.record,D);},scope:this}}});},_install:function(C,B){var A="/workspace/package/install/"+C.signature+"/";this.loadConsole(Ext.getBody(),A);Ext.apply(B,{action:"install",signature:C.signature,register:"mgr",topic:A});MODx.Ajax.request({url:this.config.url,params:B,listeners:{success:{fn:function(){Ext.getCmp("modx-window-package-installer").hide();this.refresh();Ext.getCmp("modx-layout").refreshTrees();},scope:this},failure:{fn:function(){Ext.Msg.hide();this.refresh();},scope:this}}});},getMenu:function(D,B,E){var A=[];var F=this.getSelectionModel().getSelected();var C=F.data.installed&&F.data.installed!=""&&F.data.installed!="0000-00-00 00:00:00";A.push({text:_("package_view"),handler:this.viewPackage},"-");if(F.data.provider!=0){A.push({text:_("package_check_for_updates"),handler:this.update});}A.push({text:C?_("package_reinstall"):_("package_install"),handler:this.install});if(C){A.push({text:_("package_uninstall"),handler:this.uninstall});}A.push("-",{text:_("package_remove"),handler:this.remove});if(A.length>0){this.addContextMenuItem(A);}},rendUpdateAvail:function(B,C,A){switch(B){case"":return"-";case false:C.css="red";return _("no");case true:C.css="green";return"<a href=\"javascript:void(0);\" onclick=\"Ext.getCmp('modx-grid-package').updateFromBtn(this,'"+A.data.signature+"','"+A.data.provider+"');\">"+_("yes")+"</a>";}},updateFromBtn:function(A,B){this.menu.record={signature:B};this.update(A,{});}});Ext.reg("modx-grid-package",MODx.grid.Package);MODx.window.RemovePackage=function(A){A=A||{};Ext.applyIf(A,{title:_("package_remove"),url:MODx.config.connectors_url+"workspace/packages.php",baseParams:{action:"uninstall"},defaults:{border:false},fields:[{xtype:"hidden",name:"signature",id:"modx-rpack-signature",value:A.signature},{html:_("package_remove_confirm")},MODx.PanelSpacer,{html:_("package_remove_force_desc"),border:false},MODx.PanelSpacer,{xtype:"xcheckbox",name:"force",boxLabel:_("package_remove_force"),id:"modx-rpack-force",labelSeparator:"",inputValue:"true"}],saveBtnText:_("package_remove")});MODx.window.RemovePackage.superclass.constructor.call(this,A);};Ext.extend(MODx.window.RemovePackage,MODx.Window,{submit:function(){var A=this.config.record;if(this.fp.getForm().isValid()){Ext.getCmp("modx-grid-package").loadConsole(Ext.getBody(),A.topic);this.fp.getForm().baseParams={action:"remove",signature:A.signature,register:"mgr",topic:A.topic,force:Ext.getCmp("modx-rpack-force").getValue()};this.fp.getForm().submit({waitMsg:_("saving"),scope:this,failure:function(D,B){this.fireEvent("failure",D,B);var C=Ext.getCmp("modx-grid-package");C.getConsole().fireEvent("complete");C.refresh();Ext.Msg.hide();this.hide();},success:function(D,B){this.fireEvent("success",{f:D,a:B});var C=Ext.getCmp("modx-grid-package");C.getConsole().fireEvent("complete");C.refresh();Ext.Msg.hide();this.hide();}});}}});Ext.reg("modx-window-package-remove",MODx.window.RemovePackage);