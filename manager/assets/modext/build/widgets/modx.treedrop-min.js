MODx.TreeDrop=function(A){A=A||{};Ext.applyIf(A,{id:"modx-treedrop",ddGroup:"modx-treedrop-dd"});MODx.TreeDrop.superclass.constructor.call(this,A);this.config=A;this.setup();};Ext.extend(MODx.TreeDrop,Ext.Component,{setup:function(){var C=this.config.target;var B=this.config.targetEl;var A=this.config;this.targetEl=new Ext.dd.DropTarget(this.config.targetEl,{ddGroup:this.config.ddGroup,notifyEnter:function(G,F,E){if(C.getEl){var D=C.getEl();if(D){D.frame();}}},notifyDrop:function(J,I,F){if(!F.node||!F.node.attributes||!F.node.attributes.type){return false;}if(F.node.attributes.type!="modResource"&&F.node.attributes.leaf!=true){return false;}var D="";var H=false;switch(F.node.attributes.type){case"modResource":D="[[~"+F.node.attributes.pk+"]]";break;case"snippet":H=true;break;case"chunk":H=true;break;case"tv":H=true;break;case"file":D=F.node.attributes.url;break;default:return false;break;}if(H){MODx.loadInsertElement({pk:F.node.attributes.pk,classKey:F.node.attributes.classKey,name:F.node.attributes.name,output:D,ddTargetEl:B,cfg:A,iframe:A.iframe,iframeEl:A.iframeEl,onInsert:A.onInsert,panel:A.panel});}else{if(A.iframe){MODx.insertForRTE(D,A);}else{var E=Ext.get(B);if(E.dom.id=="modx-static-content"){D=D.substring(1);Ext.getCmp(E.dom.id).setValue("");}if(E.dom.id=="modx-symlink-content"||E.dom.id=="modx-weblink-content"){Ext.getCmp(E.dom.id).setValue("");MODx.insertAtCursor(B,F.node.attributes.pk,A.onInsert);}else{if(E.dom.id=="modx-resource-parent"){D=F.node.attributes.pk;Ext.getCmp("modx-resource-parent").setValue(D);Ext.getCmp("modx-resource-parent-hidden").setValue(D);var G=Ext.getCmp("modx-panel-resource");if(G){G.markDirty();}}else{MODx.insertAtCursor(B,D,A.onInsert);}}if(A.panel){var G=Ext.getCmp(A.panel);if(G){G.markDirty();}}}}return true;}});}});Ext.reg("modx-treedrop",MODx.TreeDrop);MODx.loadInsertElement=function(A){if(MODx.InsertElementWindow){MODx.InsertElementWindow.hide();MODx.InsertElementWindow.destroy();}MODx.InsertElementWindow=MODx.load({xtype:"modx-window-insert-element",record:A,listeners:{success:{fn:function(){},scope:this},hide:{fn:function(){this.destroy();}}}});MODx.InsertElementWindow.setValues(A);MODx.InsertElementWindow.show();};MODx.insertAtCursor=function(E,C,D){if(!Ext.isEmpty(D)){var F=D(C);if(F!=undefined){C=F;}}if(document.selection){E.focus();sel=document.selection.createRange();sel.text=C;}else{if(E.selectionStart||E.selectionStart=="0"){var B=E.selectionStart;var A=E.selectionEnd;E.value=E.value.substring(0,B)+C+E.value.substring(A,E.value.length);}else{E.value+=C;}}};MODx.insertForRTE=function(B,A){var C=A.onInsert||false;if(C){C(B,A);}else{if(typeof A.iframeEl=="object"){var D=A.iframeEl;}else{var D=window.frames[0].document.getElementById(A.iframeEl);}if(D.value){D.value=D.value+B;}else{D.innerHTML=D.innerHTML+B;}}};MODx.window.InsertElement=function(A){A=A||{};Ext.applyIf(A,{title:_("select_el_opts"),id:"modx-window-insert-element",width:600,url:MODx.config.connectors_url+"element/template.php",action:"create",fields:[{xtype:"hidden",name:"pk",id:"modx-dise-pk"},{xtype:"hidden",name:"classKey",id:"modx-dise-classkey"},{xtype:"xcheckbox",fieldLabel:_("cached"),name:"cached",id:"modx-dise-cached",inputValue:1,checked:true},{xtype:"modx-combo-property-set",fieldLabel:_("property_set"),name:"propertyset",id:"modx-dise-propset",baseParams:{action:"getList",showAssociated:true,elementId:A.record.pk,elementType:A.record.classKey},listeners:{select:{fn:this.changePropertySet,scope:this}}},{id:"modx-dise-proplist",autoLoad:{url:MODx.config.connectors_url+"element/index.php",params:{action:"getInsertProperties",classKey:A.record.classKey,pk:A.record.pk,propertySet:0},scripts:true,callback:this.onPropFormLoad,scope:this},style:"display: none;"},{xtype:"fieldset",title:_("properties"),autoHeight:true,collapsible:true,autoScroll:true,items:[{html:'<div id="modx-iprops-form"></div>',height:400,autoScroll:true}]}]});MODx.window.InsertElement.superclass.constructor.call(this,A);this.on("show",function(){this.center();},this);};Ext.extend(MODx.window.InsertElement,MODx.Window,{changePropertySet:function(A){var C=Ext.getCmp("modx-iprops-fp");if(C){C.destroy();}var B=Ext.getCmp("modx-dise-proplist").getUpdater();B.update({url:MODx.config.connectors_url+"element/index.php",params:{action:"getInsertProperties",classKey:this.config.record.classKey,pk:this.config.record.pk,propertySet:A.getValue()},scripts:true,callback:this.onPropFormLoad,scope:this});this.modps=[];},createStore:function(A){return new Ext.data.SimpleStore({fields:["v","d"],data:A});},onPropFormLoad:function(C,B,D){var E=Ext.decode(D.responseText);if(!E||E.length<=0){return false;}for(var A=0;A<E.length;A++){if(E[A].store){E[A].store=this.createStore(E[A].store);}}MODx.load({xtype:"panel",id:"modx-iprops-fp",layout:"form",autoHeight:true,autoScroll:true,labelWidth:150,border:false,items:E,renderTo:"modx-iprops-form"});},submit:function(){var A="[[";var G=this.config.record.name;var D=this.fp.getForm();if(D.findField("cached").getValue()!=true){A=A+"!";}switch(this.config.record.classKey){case"modSnippet":A=A+G;break;case"modChunk":A=A+"$"+G;break;case"modTemplateVar":A=A+"*"+G;break;}var F=D.findField("propertyset").getValue();if(F!==0&&F!==""){A=A+"@"+D.findField("propertyset").getRawValue();}A=A+"?";for(var C=0;C<this.modps.length;C++){var B=this.modps[C];var E=Ext.getCmp("modx-iprop-"+B).getValue();if(E==true){E=1;}if(E==false){E=0;}A=A+" &"+B+"=`"+E+"`";}A=A+"]]";if(this.config.record.iframe){MODx.insertForRTE(A,this.config.record.cfg);}else{MODx.insertAtCursor(this.config.record.ddTargetEl,A);}this.hide();return true;},modps:[],changeProp:function(A){if(this.modps.indexOf(A)==-1){this.modps.push(A);}}});Ext.reg("modx-window-insert-element",MODx.window.InsertElement);