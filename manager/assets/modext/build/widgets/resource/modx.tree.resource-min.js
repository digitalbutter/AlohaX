MODx.tree.Resource=function(A){A=A||{};Ext.applyIf(A,{url:MODx.config.connectors_url+"resource/index.php",title:"",rootVisible:false,expandFirst:true,enableDD:!Ext.isEmpty(MODx.config.enable_dragdrop)?true:false,ddGroup:"modx-treedrop-dd",remoteToolbar:true,sortBy:MODx.config.tree_default_sort||"menuindex",tbarCfg:{id:A.id?A.id+"-tbar":"modx-tree-resource-tbar"},baseParams:{action:"getNodes",sortBy:MODx.config.tree_default_sort||"menuindex",currentResource:MODx.request.id||0}});MODx.tree.Resource.superclass.constructor.call(this,A);this.getLoader().baseParams.sortBy=Ext.state.Manager.get(this.treestate_id+"-sort")||(MODx.config.tree_default_sort||"menuindex");this.on("render",function(){var B=Ext.get("modx-resource-tree");B.createChild({tag:"div",id:"modx-resource-tree_tb"});B.createChild({tag:"div",id:"modx-resource-tree_filter"});});this.addEvents("loadCreateMenus");this.on("afterSort",this._handleAfterDrop,this);};Ext.extend(MODx.tree.Resource,MODx.tree.Tree,{forms:{},windows:{},stores:{},_initExpand:function(){var A=Ext.state.Manager.get(this.treestate_id);if((Ext.isString(A)||Ext.isEmpty(A))&&this.root){if(this.root){this.root.expand();}var C=this.getNodeById("web_0");if(C&&this.config.expandFirst){C.select();C.expand();}}else{for(var B=0;B<A.length;B++){this.expandPath(A[B]);}}},_showContextMenu:function(C,B){C.select();this.cm.activeNode=C;this.cm.removeAll();if(C.attributes.menu&&C.attributes.menu.items){this.addContextMenuItem(C.attributes.menu.items);this.cm.show(C.getUI().getEl(),"t?");}else{var A=[];switch(C.attributes.type){case"modResource":A=this._getModResourceMenu(C);break;case"modContext":A=this._getModContextMenu(C);break;}this.addContextMenuItem(A);this.cm.showAt(B.xy);}B.stopEvent();},duplicateResource:function(D,E){var C=this.cm.activeNode;var F=C.id.split("_");F=F[1];var B={resource:F,is_folder:C.getUI().hasClass("folder")};var A=MODx.load({xtype:"modx-window-resource-duplicate",resource:F,is_folder:B.is_folder,listeners:{success:{fn:function(){this.refreshNode(C.id);},scope:this}}});A.setValues(B);A.show(E.target);},duplicateContext:function(E,D){var C=this.cm.activeNode;var A=C.attributes.pk;var B={key:A,newkey:""};if(!this.windows.duplicateContext){this.windows.duplicateContext=MODx.load({xtype:"modx-window-context-duplicate",record:B,listeners:{success:{fn:function(){this.refresh();},scope:this}}});}this.windows.duplicateContext.setValues(B);this.windows.duplicateContext.show(D.target);},removeContext:function(D,C){var B=this.cm.activeNode;var A=B.attributes.pk;MODx.msg.confirm({title:_("context_remove"),text:_("context_remove_confirm"),url:MODx.config.connectors_url+"context/index.php",params:{action:"remove",key:A},listeners:{success:{fn:function(){this.refresh();},scope:this}}});},preview:function(){window.open(this.cm.activeNode.attributes.preview_url);},deleteDocument:function(D,B){var A=this.cm.activeNode;var C=A.id.split("_");C=C[1];MODx.msg.confirm({title:_("resource_delete"),text:_("resource_delete_confirm"),url:MODx.config.connectors_url+"resource/index.php",params:{action:"delete",id:C},listeners:{success:{fn:function(){var F=this.cm.activeNode;var E=F.getUI();E.addClass("deleted");F.cascade(function(G){G.getUI().addClass("deleted");},this);Ext.get(E.getEl()).frame();},scope:this}}});},undeleteDocument:function(D,B){var A=this.cm.activeNode;var C=A.id.split("_");C=C[1];MODx.Ajax.request({url:MODx.config.connectors_url+"resource/index.php",params:{action:"undelete",id:C},listeners:{success:{fn:function(){var F=this.cm.activeNode;var E=F.getUI();E.removeClass("deleted");F.cascade(function(G){G.getUI().removeClass("deleted");},this);Ext.get(E.getEl()).frame();},scope:this}}});},publishDocument:function(D,B){var A=this.cm.activeNode;var C=A.id.split("_");C=C[1];MODx.msg.confirm({title:_("resource_publish"),text:_("resource_publish_confirm"),url:MODx.config.connectors_url+"resource/index.php",params:{action:"publish",id:C},listeners:{success:{fn:function(){var E=this.cm.activeNode.getUI();E.removeClass("unpublished");Ext.get(E.getEl()).frame();},scope:this}}});},unpublishDocument:function(D,B){var A=this.cm.activeNode;var C=A.id.split("_");C=C[1];MODx.msg.confirm({title:_("resource_unpublish"),text:_("resource_unpublish_confirm"),url:MODx.config.connectors_url+"resource/index.php",params:{action:"unpublish",id:C},listeners:{success:{fn:function(){var E=this.cm.activeNode.getUI();E.addClass("unpublished");Ext.get(E.getEl()).frame();},scope:this}}});},emptyRecycleBin:function(){MODx.msg.confirm({title:_("empty_recycle_bin"),text:_("empty_recycle_bin_confirm"),url:MODx.config.connectors_url+"resource/index.php",params:{action:"emptyRecycleBin"},listeners:{success:{fn:function(){Ext.select("div.deleted",this.getRootNode()).remove();MODx.msg.status({title:_("success"),message:_("empty_recycle_bin_emptied")});},scope:this}}});},showFilter:function(F,E){if(this._filterVisible){return false;}var C=Ext.get(this.config.id+"-tbar");var D=C.createChild({tag:"div",cls:"modx-formpanel",autoHeight:true});var B=new Ext.Toolbar({applyTo:D,autoHeight:true,width:"100%"});var A=new Ext.form.ComboBox({store:new Ext.data.SimpleStore({fields:["name","value"],data:[[_("menu_order"),"menuindex"],[_("page_title"),"pagetitle"],[_("publish_date"),"pub_date"],[_("createdon"),"createdon"],[_("editedon"),"editedon"],[_("publishedon"),"publishedon"]]}),displayField:"name",valueField:"value",editable:false,mode:"local",id:"modx-resource-tree-sortby",triggerAction:"all",selectOnFocus:false,width:100,value:this.config.sortBy||(Ext.state.Manager.get(this.treestate_id+"-sort")||MODx.config.tree_default_sort),listeners:{select:{fn:this.filterSort,scope:this}}});B.add(_("sort_by")+":");B.addField(A);B.add("-",{scope:this,cls:"x-btn-text",text:_("close"),handler:this.hideFilter});B.doLayout();this.filterBar=B;this._filterVisible=true;return true;},filterSort:function(A,C,B){Ext.state.Manager.set(this.treestate_id+"-sort",A.getValue());this.config.sortBy=A.getValue();this.getLoader().baseParams={action:this.config.action,sortBy:this.config.sortBy};this.refresh();},hideFilter:function(B,A){this.filterBar.destroy();this._filterVisible=false;},_handleAfterDrop:function(D,A){var C=D.event.target;if(D.event.point=="append"&&C){var B=C.getUI();B.addClass("haschildren");B.removeClass("icon-resource");}},_handleDrop:function(D){var A=D.dropNode;var C=D.target;if(C.findChild("id",A.attributes.id)!==null){return false;}var B=true;if(C.attributes.type=="context"&&D.point!="append"){B=false;}return A.attributes.text!="root"&&A.attributes.text!==""&&C.attributes.text!="root"&&C.attributes.text!==""&&B;},quickCreate:function(G,F,C,B,E){C=C||"modResource";var D={class_key:C,context_key:B||"web",parent:E||0};var A=MODx.load({xtype:"modx-window-quick-create-modResource",record:D,listeners:{success:{fn:function(){var H=this.getNodeById(this.cm.activeNode.id);if(H){var I=H.parentNode?H.parentNode:H;this.getLoader().load(I,function(){I.expand();},this);}},scope:this},hide:{fn:function(){this.destroy();}},show:{fn:function(){this.center();}}}});A.setValues(D);A.show(F.target,function(){Ext.isSafari?A.setPosition(null,30):A.center();},this);},quickUpdate:function(C,B,A){MODx.Ajax.request({url:MODx.config.connectors_url+"resource/index.php",params:{action:"get",id:this.cm.activeNode.attributes.pk},listeners:{success:{fn:function(E){var F=E.object;F.class_key=A;var D=MODx.load({xtype:"modx-window-quick-update-modResource",record:F,listeners:{success:{fn:function(){this.refreshNode(this.cm.activeNode.id);},scope:this},hide:{fn:function(){this.destroy();}}}});D.setValues(E.object);D.show(B.target,function(){Ext.isSafari?D.setPosition(null,30):D.center();},this);},scope:this}}});},_getModContextMenu:function(D){var B=D.attributes;var C=D.getUI();var A=[];A.push({text:"<b>"+B.text+"</b>",handler:function(){return false;},header:true});A.push("-");if(C.hasClass("pedit")){A.push({text:_("edit_context"),handler:function(){var E=this.cm.activeNode.attributes;this.loadAction("a="+MODx.action["context/update"]+"&key="+E.pk);}});}A.push({text:_("context_refresh"),handler:function(){this.refreshNode(this.cm.activeNode.id,true);}});if(C.hasClass("pnewdoc")){A.push("-");this._getCreateMenus(A,"0",C);}if(C.hasClass("pnew")){A.push({text:_("context_duplicate"),handler:this.duplicateContext});}if(C.hasClass("pdelete")){A.push("-");A.push({text:_("context_remove"),handler:this.removeContext});}return A;},_getModResourceMenu:function(D){var B=D.attributes;var C=D.getUI();var A=[];A.push({text:"<b>"+B.text+"</b>",handler:function(){return false;},header:true});A.push("-");if(C.hasClass("pview")){A.push({text:_("resource_view"),handler:function(){this.loadAction("a="+MODx.action["resource/data"]);}});}if(C.hasClass("pedit")){A.push({text:_("resource_edit"),handler:function(){this.loadAction("a="+MODx.action["resource/update"]);}});}if(C.hasClass("pqupdate")){A.push({text:_("quick_update_resource"),classKey:B.classKey,handler:function(F,E){Ext.getCmp("modx-resource-tree").quickUpdate(F,E,F.classKey);}});}if(C.hasClass("pnew")){A.push({text:_("resource_duplicate"),handler:this.duplicateResource});}A.push({text:_("resource_refresh"),handler:function(){this.refreshNode(this.cm.activeNode.id);},scope:this});if(C.hasClass("pnew")){A.push("-");this._getCreateMenus(A,null,C);}if(C.hasClass("psave")){A.push("-");if(C.hasClass("ppublish")&&C.hasClass("unpublished")){A.push({text:_("resource_publish"),handler:this.publishDocument});}else{if(C.hasClass("punpublish")){A.push({text:_("resource_unpublish"),handler:this.unpublishDocument});}}if(C.hasClass("pundelete")&&C.hasClass("deleted")){A.push({text:_("resource_undelete"),handler:this.undeleteDocument});}else{if(C.hasClass("pdelete")&&!C.hasClass("deleted")){A.push({text:_("resource_delete"),handler:this.deleteDocument});}}}if(C.hasClass("pview")){A.push("-");A.push({text:_("resource_preview"),handler:this.preview});}return A;},_getCreateMenus:function(C,E,I){var H=MODx.resourceTypes||{document:"modDocument",weblink:"modWebLink",symlink:"modSymLink",static_resource:"modStaticResource"};if(MODx.config.custom_resource_classes){var G=MODx.config.custom_resource_classes;if(!Ext.isEmpty(G)){for(var D in G){H[D]=G[D];}}}var B=this.fireEvent("loadCreateMenus",H);if(Ext.isObject(B)){Ext.apply(H,B);}var F=[];var A=[];for(var D in H){F.push({text:_(D+"_create_here"),classKey:H[D],usePk:E?E:false,handler:function(L){var J=this.cm.activeNode.attributes;var K=L.usePk?L.usePk:J.pk;Ext.getCmp("modx-resource-tree").loadAction("a="+MODx.action["resource/create"]+"&class_key="+L.classKey+"&parent="+K+(J.ctx?"&context_key="+J.ctx:""));},scope:this});if(I&&I.hasClass("pqcreate")){A.push({text:_(D),classKey:H[D],handler:function(M,L){var J=this.cm.activeNode.attributes;var K=M.usePk?M.usePk:J.pk;Ext.getCmp("modx-resource-tree").quickCreate(M,L,M.classKey,J.ctx,K);},scope:this});}}C.push({text:_("create"),handler:function(){return false;},menu:{items:F}});if(I&&I.hasClass("pqcreate")){C.push({text:_("quick_create"),handler:function(){return false;},menu:{items:A}});}return C;}});Ext.reg("modx-tree-resource",MODx.tree.Resource);MODx.window.QuickCreateResource=function(A){A=A||{};this.ident=A.ident||"qcr"+Ext.id();Ext.applyIf(A,{title:_("quick_create_resource"),id:this.ident,width:620,url:MODx.config.connectors_url+"resource/index.php",action:"create",shadow:false,fields:[{xtype:"modx-tabs",bodyStyle:{background:"transparent"},deferredRender:false,autoHeight:true,items:[{title:_("resource"),layout:"form",cls:"modx-panel",bodyStyle:{background:"transparent",padding:"10px"},autoHeight:true,labelWidth:100,items:[{xtype:"modx-combo-template",name:"template",id:"modx-"+this.ident+"-template",fieldLabel:_("template"),editable:false,anchor:"100%",baseParams:{action:"getList",combo:"1"},value:MODx.config.default_template},{xtype:"textfield",name:"pagetitle",id:"modx-"+this.ident+"-pagetitle",fieldLabel:_("pagetitle"),anchor:"100%"},{xtype:"textfield",name:"longtitle",id:"modx-"+this.ident+"-longtitle",fieldLabel:_("long_title"),anchor:"100%"},{xtype:"textarea",name:"description",id:"modx-"+this.ident+"-description",fieldLabel:_("description"),anchor:"100%",grow:false,height:50},{xtype:"textfield",name:"alias",id:"modx-"+this.ident+"-alias",fieldLabel:_("alias"),anchor:"100%"},{xtype:"textarea",name:"introtext",id:"modx-"+this.ident+"-introtext",fieldLabel:_("introtext"),anchor:"100%",height:50},{xtype:"textfield",name:"menutitle",id:"modx-"+this.ident+"-menutitle",fieldLabel:_("resource_menutitle"),anchor:"100%"},MODx.getQRContentField(this.ident,A.record.class_key)]},{id:"modx-"+this.ident+"-settings",title:_("settings"),layout:"form",cls:"modx-panel",autoHeight:true,forceLayout:true,labelWidth:100,defaults:{autoHeight:true,border:false},style:"background: transparent;",bodyStyle:{background:"transparent",padding:"10px"},items:MODx.getQRSettings(this.ident,A.record)}]}],keys:[{key:Ext.EventObject.ENTER,shift:true,fn:this.submit,scope:this}]});MODx.window.QuickCreateResource.superclass.constructor.call(this,A);};Ext.extend(MODx.window.QuickCreateResource,MODx.Window);Ext.reg("modx-window-quick-create-modResource",MODx.window.QuickCreateResource);MODx.window.QuickUpdateResource=function(A){A=A||{};this.ident=A.ident||"qur"+Ext.id();Ext.applyIf(A,{title:_("quick_update_resource"),id:this.ident,width:620,url:MODx.config.connectors_url+"resource/index.php",action:"update",autoHeight:true,shadow:false,fields:[{xtype:"modx-tabs",bodyStyle:{background:"transparent"},autoHeight:true,deferredRender:false,items:[{title:_("resource"),layout:"form",cls:"modx-panel",bodyStyle:{background:"transparent",padding:"10px"},autoHeight:true,labelWidth:100,items:[{xtype:"hidden",name:"id",id:"modx-"+this.ident+"-id"},{xtype:"modx-combo-template",name:"template",id:"modx-"+this.ident+"-template",fieldLabel:_("template"),editable:false,anchor:"100%",baseParams:{action:"getList",combo:"1"}},{xtype:"textfield",name:"pagetitle",id:"modx-"+this.ident+"-pagetitle",fieldLabel:_("pagetitle"),anchor:"100%"},{xtype:"textfield",name:"longtitle",id:"modx-"+this.ident+"-longtitle",fieldLabel:_("long_title"),anchor:"100%"},{xtype:"textarea",name:"description",id:"modx-"+this.ident+"-description",fieldLabel:_("description"),anchor:"100%",grow:false,height:50},{xtype:"textfield",name:"alias",id:"modx-"+this.ident+"-alias",fieldLabel:_("alias"),anchor:"100%"},{xtype:"textfield",name:"menutitle",id:"modx-"+this.ident+"-menutitle",fieldLabel:_("resource_menutitle"),anchor:"100%"},{xtype:"textarea",name:"introtext",id:"modx-"+this.ident+"-introtext",fieldLabel:_("introtext"),anchor:"100%",height:50},MODx.getQRContentField(this.ident,A.record.class_key)]},{id:"modx-"+this.ident+"-settings",title:_("settings"),layout:"form",cls:"modx-panel",autoHeight:true,forceLayout:true,labelWidth:100,defaults:{autoHeight:true,border:false},style:"background: transparent;",bodyStyle:{background:"transparent",padding:"10px"},items:MODx.getQRSettings(this.ident,A.record)}]}],keys:[{key:Ext.EventObject.ENTER,shift:true,fn:this.submit,scope:this}],buttons:[{text:A.cancelBtnText||_("cancel"),scope:this,handler:function(){this.hide();}},{text:A.saveBtnText||_("save"),scope:this,handler:function(){this.submit(false);}},{text:A.saveBtnText||_("save_and_close"),scope:this,handler:this.submit}]});MODx.window.QuickUpdateResource.superclass.constructor.call(this,A);};Ext.extend(MODx.window.QuickUpdateResource,MODx.Window);Ext.reg("modx-window-quick-update-modResource",MODx.window.QuickUpdateResource);MODx.getQRContentField=function(C,A){C=C||"qur";A=A||"modResource";var B={};switch(A){case"modSymLink":B={xtype:"textfield",fieldLabel:_("symlink"),name:"content",id:"modx-"+C+"-content",anchor:"100%",maxLength:255,allowBlank:false};break;case"modWebLink":B={xtype:"textfield",fieldLabel:_("weblink"),name:"content",id:"modx-"+C+"-content",anchor:"100%",maxLength:255,value:"http://",allowBlank:false};break;case"modStaticResource":B={xtype:"modx-combo-browser",browserEl:"modx-browser",prependPath:false,prependUrl:false,hideFiles:true,fieldLabel:_("static_resource"),name:"content",id:"modx-"+C+"-content",anchor:"100%",maxLength:255,value:"",listeners:{select:{fn:function(D){if(D.url.substring(0,1)=="/"){Ext.getCmp("modx-"+C+"-content").setValue(D.url.substring(1));}},scope:this}}};break;case"modResource":default:B={xtype:"textarea",name:"content",id:"modx-"+C+"-content",hideLabel:true,labelSeparator:"",anchor:"100%",height:300};break;}return B;};MODx.getQRSettings=function(B,A){B=B||"qur";return[{xtype:"hidden",name:"parent",id:"modx-"+B+"-parent",value:A.parent},{xtype:"hidden",name:"context_key",id:"modx-"+B+"-context_key",value:A.context_key},{xtype:"hidden",name:"class_key",id:"modx-"+B+"-class_key",value:A.class_key},{xtype:"hidden",name:"publishedon",id:"modx-"+B+"-publishedon",value:A.publishedon},{xtype:"xcheckbox",name:"published",id:"modx-"+B+"-published",fieldLabel:_("resource_published"),description:_("resource_published_help"),inputValue:1,checked:A.published!==undefined?A.published:(MODx.config.publish_default=="1"?1:0)},{xtype:"xcheckbox",fieldLabel:_("resource_folder"),description:_("resource_folder_help"),name:"isfolder",id:"modx-"+B+"-isfolder",inputValue:1,checked:A.isfolder!=undefined?A.isfolder:false},{xtype:"xcheckbox",fieldLabel:_("resource_richtext"),description:_("resource_richtext_help"),name:"richtext",id:"modx-"+B+"-richtext",inputValue:1,checked:A.richtext!==undefined?(A.richtext?1:0):(MODx.config.richtext_default=="1"?1:0)},{xtype:"xcheckbox",fieldLabel:_("resource_searchable"),description:_("resource_searchable_help"),name:"searchable",id:"modx-"+B+"-searchable",inputValue:1,checked:A.searchable!=undefined?A.searchable:(MODx.config.search_default=="1"?1:0),listeners:{check:{fn:MODx.handleQUCB}}},{xtype:"xcheckbox",fieldLabel:_("resource_hide_from_menus"),description:_("resource_hide_from_menus_help"),name:"hidemenu",id:"modx-"+B+"-hidemenu",inputValue:1,checked:A.hidemenu!=undefined?A.hidemenu:(MODx.config.hidemenu_default=="1"?1:0)},{xtype:"xcheckbox",fieldLabel:_("resource_cacheable"),description:_("resource_cacheable_help"),name:"cacheable",id:"modx-"+B+"-cacheable",inputValue:1,checked:A.cacheable!=undefined?A.cacheable:(MODx.config.cache_default=="1"?1:0)},{xtype:"xcheckbox",name:"clearCache",id:"modx-"+B+"-clearcache",fieldLabel:_("clear_cache_on_save"),description:_("clear_cache_on_save_msg"),inputValue:1,checked:true}];};MODx.handleQUCB=function(A){var B=Ext.getCmp(A.id+"-hd");if(A.checked&&B){A.setValue(1);B.setValue(1);}else{if(B){A.setValue(0);B.setValue(0);}}};