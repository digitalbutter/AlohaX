Ext.ns("MODx.orm");MODx.orm.Tree=function(A){A=A||{};Ext.applyIf(A,{height:300,width:400,useArrows:true,autoScroll:true,animate:true,enableDD:false,border:false,containerScroll:true,rootVisible:false,root:new Ext.tree.AsyncTreeNode({expanded:true,children:A.data,listeners:{load:{fn:function(){this.expandAll();},scope:this}}}),tbar:[{text:_("orm_attribute_add"),handler:function(B,C){this.addAttribute(B,C);},scope:this},{text:_("orm_container_add"),handler:function(B,C){this.addContainer(B,C);},scope:this}],menuConfig:{defaultAlign:"tl-b?",enableScrolling:false}});MODx.orm.Tree.superclass.constructor.call(this,A);this.config=A;this.on("click",this.onClick,this);this.on("contextmenu",this._showContextMenu,this);this.cm=new Ext.menu.Menu(A.menuConfig);};Ext.extend(MODx.orm.Tree,Ext.tree.TreePanel,{windows:{},getSelectedNode:function(){return this.getSelectionModel().getSelectedNode();},addContextMenuItem:function(C){var B=C,A=B.length;for(var D=0;D<A;D++){B[D].scope=this;this.cm.add(B[D]);}},_showContextMenu:function(B,C){B.select();this.cm.activeNode=B;this.cm.removeAll();var A=[];if(B.attributes.leaf){A.push({text:_("orm_attribute_remove"),handler:this.removeAttribute,scope:this});}else{A.push({text:_("orm_attribute_add_below"),handler:function(E,D){this.addAttribute(E,D,this.cm.activeNode);},scope:this});A.push({text:_("orm_container_add_below"),handler:function(E,D){this.addContainer(E,D,this.cm.activeNode);},scope:this});A.push("-");A.push({text:_("orm_container_rename"),handler:function(E,D){this.renameContainer(E,D,this.cm.activeNode);},scope:this});A.push("-");A.push({text:_("orm_container_remove"),handler:this.removeContainer,scope:this});}if(A.length>0){this.addContextMenuItem(A);this.cm.showAt(C.xy);}C.stopEvent();},markFormPanelDirty:function(B){var A=Ext.getCmp(B?B:this.config.formPanel);if(A){A.markDirty();}},removeAttribute:function(A,B){var C=this.getSelectedNode();if(C){Ext.Msg.confirm(_("orm_attribute_remove"),_("orm_attribute_remove_confirm"),function(D){if(D=="yes"){C.remove();this.markFormPanelDirty();}},this);}},removeContainer:function(A,B){var C=this.getSelectedNode();if(C){Ext.Msg.confirm(_("orm_container_remove"),_("orm_container_remove_confirm"),function(D){if(D=="yes"){C.remove();this.markFormPanelDirty();}},this);}},addContainer:function(A,D,C){var B={};if(C){B.parent=C.id;}if(!this.windows.addContainer){this.windows.addContainer=MODx.load({xtype:"modx-orm-window-container-add",record:B,tree:this,listeners:{success:{fn:function(F){var H=new Ext.tree.TreeNode({text:F.name,id:F.name,name:F.name,expanded:true,expandable:true,leaf:false});var G=this.getSelectedNode();var E=G&&!G.attributes.value?G:this.getRootNode();E.appendChild(H);this.markFormPanelDirty();},scope:this}}});}this.windows.addContainer.setValues(B);this.windows.addContainer.show(D.target);},renameContainer:function(A,D,C){var B={};if(C){B.parent=C.id;}if(!this.windows.renameContainer){this.windows.renameContainer=MODx.load({xtype:"modx-orm-window-container-rename",record:B,listeners:{success:{fn:function(E){var F=this.getSelectedNode();F.setId(E.name);F.setText(E.name);this.markFormPanelDirty();},scope:this}}});}this.windows.renameContainer.setValues(B);this.windows.renameContainer.show(D.target);},addAttribute:function(A,D,C){var B={};if(C){B.parent=C.id;}if(!this.windows.addAttribute){this.windows.addAttribute=MODx.load({xtype:"modx-orm-window-attribute-add",record:B,tree:this,listeners:{success:{fn:function(F){var H=new Ext.tree.TreeNode({text:F.name+" - <i>"+F.value+"</i>",id:F.id,name:F.name,leaf:true,value:F.value});var G=this.getSelectedNode();var E=G&&!G.attributes.value?G:this.getRootNode();E.appendChild(H);this.markFormPanelDirty();},scope:this}}});}this.windows.addAttribute.setValues(B);this.windows.addAttribute.show(D.target);},encode:function(B){if(!B){B=this.getRootNode();}var C=function(G){var D={};var E=G.childNodes;for(var F=0;F<E.length;F=F+1){var I=E[F];var H=C(I);if(I.attributes.value!=null&&I.attributes.value!=undefined){D[I.attributes.name]=I.attributes.value;}else{D[I.attributes.name]=H;}}return D;};var A=C(B);return Ext.encode(A);},onClick:function(C){var B=C.attributes;if(B.value!=null&&B.value!=undefined){var A=Ext.getCmp(this.config.formPanel).getForm();A.findField(this.config.prefix+"_id").setValue(B.id);A.findField(this.config.prefix+"_name").setValue(B.name);A.findField(this.config.prefix+"_value").setValue(B.value);}},childExistsOnSelected:function(C){var B=this.getSelectedNode();var A;if(Ext.isEmpty(B)){A=this.getNodeById(C);if(A&&!Ext.isEmpty(A.parentNode.text)){A=null;}}else{A=B.findChild("id",C);}if(!Ext.isEmpty(A)){return true;}return false;}});Ext.reg("modx-orm-tree",MODx.orm.Tree);MODx.orm.Form=function(A){Ext.applyIf(A,{layout:"form",xtype:"fieldset",labelWidth:150,autoHeight:true,border:false,bodyStyle:"padding: 15px 0;",defaults:{msgTarget:"side",border:false},buttonAlign:"center",items:[{xtype:"textfield",name:A.prefix+"_name",fieldLabel:_("name"),anchor:"95%"},{xtype:"textfield",name:A.prefix+"_value",fieldLabel:_("value"),anchor:"95%"},{xtype:"hidden",name:A.prefix+"_id"}],buttons:[{text:_("set"),handler:this.saveProperty,scope:this}]});MODx.orm.Form.superclass.constructor.call(this,A);this.config=A;};Ext.extend(MODx.orm.Form,Ext.Panel,{saveProperty:function(){var B=Ext.getCmp(this.config.formPanel);var C=Ext.getCmp(this.config.treePanel);if(!B||!C){return false;}var D=B.getForm();var F=C.getSelectionModel().getSelectedNode();var A=D.findField(this.config.prefix+"_name").getValue();var E=D.findField(this.config.prefix+"_value").getValue();F.attributes.id=D.findField(this.config.prefix+"_id").getValue();F.attributes.text=A;F.attributes.value=E;F.setText(A+" - <i>"+Ext.util.Format.ellipsis(E,33)+"</i>");B.markDirty();return true;}});Ext.reg("modx-orm-form",MODx.orm.Form);MODx.window.AddOrmAttribute=function(A){A=A||{};this.ident=A.ident||"ormcattr"+Ext.id();Ext.applyIf(A,{title:_("orm_attribute_add"),id:this.ident,height:150,width:350,fields:[{xtype:"hidden",name:"parent",value:0},{xtype:"textfield",fieldLabel:_("name"),name:"name",id:"modx-"+this.ident+"-name",anchor:"85%",allowBlank:false},{xtype:"textfield",fieldLabel:_("value"),name:"value",id:"modx-"+this.ident+"-value",anchor:"85%"}]});MODx.window.AddOrmAttribute.superclass.constructor.call(this,A);};Ext.extend(MODx.window.AddOrmAttribute,MODx.Window,{submit:function(){var A=this.fp.getForm().getValues();if(this.config.tree.childExistsOnSelected(A.name)){this.fp.getForm().markInvalid({name:_("orm_attribute_ae")});return false;}if(this.fp.getForm().isValid()){if(this.fireEvent("success",A)){this.fp.getForm().reset();this.hide();return true;}}return false;}});Ext.reg("modx-orm-window-attribute-add",MODx.window.AddOrmAttribute);MODx.window.AddOrmContainer=function(A){A=A||{};this.ident=A.ident||"ormccont"+Ext.id();Ext.applyIf(A,{title:_("orm_container_add"),id:this.ident,height:150,width:350,fields:[{xtype:"hidden",name:"parent",value:0},{xtype:"textfield",fieldLabel:_("name"),name:"name",id:"modx-"+this.ident+"-name",anchor:"85%",allowBlank:false}]});MODx.window.AddOrmContainer.superclass.constructor.call(this,A);};Ext.extend(MODx.window.AddOrmContainer,MODx.Window,{submit:function(){var A=this.fp.getForm().getValues();if(this.config.tree.childExistsOnSelected(A.name)){this.fp.getForm().markInvalid({name:_("orm_attribute_ae")});return false;}if(this.fp.getForm().isValid()){if(this.fireEvent("success",A)){this.fp.getForm().reset();this.hide();return true;}}return false;}});Ext.reg("modx-orm-window-container-add",MODx.window.AddOrmContainer);MODx.window.RenameOrmContainer=function(A){A=A||{};this.ident=A.ident||"ormrcont"+Ext.id();Ext.applyIf(A,{title:_("orm_container_rename"),id:this.ident,height:150,width:350,fields:[{xtype:"hidden",name:"parent",value:0},{xtype:"textfield",fieldLabel:_("name"),name:"name",id:"modx-"+this.ident+"-name",anchor:"85%",allowBlank:false}]});MODx.window.RenameOrmContainer.superclass.constructor.call(this,A);};Ext.extend(MODx.window.RenameOrmContainer,MODx.Window,{submit:function(){var A=this.fp.getForm().getValues();if(this.fp.getForm().isValid()){if(this.fireEvent("success",A)){this.fp.getForm().reset();this.hide();return true;}}return false;}});Ext.reg("modx-orm-window-container-rename",MODx.window.RenameOrmContainer);