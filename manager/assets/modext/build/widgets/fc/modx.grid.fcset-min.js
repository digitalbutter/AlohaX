MODx.grid.FCSet=function(A){A=A||{};this.sm=new Ext.grid.CheckboxSelectionModel();Ext.applyIf(A,{id:"modx-grid-fc-set",url:MODx.config.connectors_url+"security/forms/set.php",fields:["id","profile","action","controller","description","active","template","templatename","constraint_data","constraint","constraint_field","constraint_class","rules","perm"],paging:true,autosave:true,sm:this.sm,remoteSort:true,autoExpandColumn:"controller",columns:[this.sm,{header:_("id"),dataIndex:"id",width:40,sortable:true},{header:_("action"),dataIndex:"controller",width:200,editable:true,sortable:true},{header:_("description"),dataIndex:"description",width:200,editable:true,sortable:true},{header:_("template"),dataIndex:"templatename",width:150},{header:_("constraint"),dataIndex:"constraint_data",width:200,editable:false,sortable:false}],viewConfig:{forceFit:true,enableRowBody:true,scrollOffset:0,autoFill:true,showPreview:true,getRowClass:function(D,B,C){return D.data.active?"grid-row-active":"grid-row-inactive";}},tbar:[{text:_("set_new"),scope:this,handler:this.createSet},"-",{text:_("bulk_actions"),menu:[{text:_("selected_activate"),handler:this.activateSelected,scope:this},{text:_("selected_deactivate"),handler:this.deactivateSelected,scope:this},"-",{text:_("selected_remove"),handler:this.removeSelected,scope:this}]},"-",{text:_("import_from_xml"),handler:this.importSet,scope:this},"->",{xtype:"textfield",name:"search",id:"modx-fcs-search",emptyText:_("filter_by_search"),listeners:{change:{fn:this.search,scope:this},render:{fn:function(B){new Ext.KeyMap(B.getEl(),{key:Ext.EventObject.ENTER,fn:function(){this.fireEvent("change",this.getValue());this.blur();return true;},scope:B});},scope:this}}},{xtype:"button",id:"modx-filter-clear",text:_("filter_clear"),listeners:{click:{fn:this.clearFilter,scope:this}}}]});MODx.grid.FCSet.superclass.constructor.call(this,A);};Ext.extend(MODx.grid.FCSet,MODx.grid.Grid,{getMenu:function(){var B=this.getSelectionModel().getSelected();var C=B.data.perm;var A=[];if(this.getSelectionModel().getCount()>1){A.push({text:_("selected_activate"),handler:this.activateSelected});A.push({text:_("selected_deactivate"),handler:this.deactivateSelected});A.push("-");A.push({text:_("selected_remove"),handler:this.removeSelected});}else{if(C.indexOf("pedit")!=-1){A.push({text:_("edit"),handler:this.updateSet});A.push({text:_("duplicate"),handler:this.duplicateSet});A.push({text:_("export"),handler:this.exportSet});A.push("-");if(B.data.active){A.push({text:_("deactivate"),handler:this.deactivateSet});}else{A.push({text:_("activate"),handler:this.activateSet});}}if(C.indexOf("premove")!=-1){A.push("-",{text:_("remove"),handler:this.confirm.createDelegate(this,["remove","set_remove_confirm"])});}}if(A.length>0){this.addContextMenuItem(A);}},search:function(D,C,B){var A=C||D;this.getStore().baseParams.search=Ext.isEmpty(A)||Ext.isObject(A)?"":A;this.getBottomToolbar().changePage(1);this.refresh();return true;},clearFilter:function(){this.getStore().baseParams={action:"getList",profile:MODx.request.id};Ext.getCmp("modx-fcs-search").reset();this.getBottomToolbar().changePage(1);this.refresh();},exportSet:function(A,B){var C=this.menu.record.id;MODx.Ajax.request({url:this.config.url,params:{action:"export",id:C},listeners:{success:{fn:function(D){location.href=this.config.url+"?action=export&download="+D.message+"&id="+C+"&HTTP_MODAUTH="+MODx.siteId;},scope:this}}});},importSet:function(A,C){var B={profile:MODx.request.id};if(!this.windows.impset){this.windows.impset=MODx.load({xtype:"modx-window-fc-set-import",record:B,listeners:{success:{fn:function(D){this.refresh();},scope:this}}});}this.windows.impset.reset();this.windows.impset.setValues(B);this.windows.impset.show(C.target);},createSet:function(A,C){var B={profile:MODx.request.id,active:true};if(!this.windows.cset){this.windows.cset=MODx.load({xtype:"modx-window-fc-set-create",record:B,listeners:{success:{fn:function(D){this.refresh();},scope:this}}});}this.windows.cset.reset();this.windows.cset.setValues(B);this.windows.cset.show(C.target);},updateSet:function(A,C){var B=this.menu.record;location.href="?a="+MODx.action["security/forms/set/update"]+"&id="+B.id;},duplicateSet:function(A,B){MODx.Ajax.request({url:this.config.url,params:{action:"duplicate",id:this.menu.record.id},listeners:{success:{fn:this.refresh,scope:this}}});},activateSet:function(A,B){MODx.Ajax.request({url:this.config.url,params:{action:"activate",id:this.menu.record.id},listeners:{success:{fn:this.refresh,scope:this}}});},activateSelected:function(){var A=this.getSelectedAsList();if(A===false){return false;}MODx.Ajax.request({url:this.config.url,params:{action:"activateMultiple",sets:A},listeners:{success:{fn:function(B){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},deactivateSet:function(A,B){MODx.Ajax.request({url:this.config.url,params:{action:"deactivate",id:this.menu.record.id},listeners:{success:{fn:this.refresh,scope:this}}});},deactivateSelected:function(){var A=this.getSelectedAsList();if(A===false){return false;}MODx.Ajax.request({url:this.config.url,params:{action:"deactivateMultiple",sets:A},listeners:{success:{fn:function(B){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},removeSelected:function(){var A=this.getSelectedAsList();if(A===false){return false;}MODx.msg.confirm({title:_("set_remove_multiple"),text:_("set_remove_multiple_confirm"),url:this.config.url,params:{action:"removeMultiple",sets:A},listeners:{success:{fn:function(B){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;}});Ext.reg("modx-grid-fc-set",MODx.grid.FCSet);MODx.window.CreateFCSet=function(A){A=A||{};Ext.applyIf(A,{title:_("set_create"),url:MODx.config.connectors_url+"security/forms/set.php",action:"create",height:150,width:375,fields:[{xtype:"hidden",name:"profile",value:MODx.request.id},{fieldLabel:_("action"),name:"action_id",hiddenName:"action_id",id:"modx-fcsc-action",xtype:"modx-combo-fc-action",editable:false,allowBlank:false,anchor:"90%"},{xtype:"textarea",name:"description",fieldLabel:_("description"),id:"modx-fcsc-description",anchor:"90%"},{xtype:"modx-combo-template",name:"template",hiddenName:"template",fieldLabel:_("template"),description:_("set_template_desc"),id:"modx-fcsc-template",anchor:"90%",baseParams:{action:"getList",combo:true}},{html:"<hr />"},{xtype:"hidden",fieldLabel:_("constraint_class"),name:"constraint_class",anchor:"90%",allowBlank:true,value:"modResource"},{xtype:"textfield",fieldLabel:_("constraint_field"),description:_("set_constraint_field_desc"),name:"constraint_field",anchor:"90%",allowBlank:true},{xtype:"textfield",fieldLabel:_("constraint"),description:_("set_constraint_desc"),name:"constraint",anchor:"90%",allowBlank:true},{xtype:"xcheckbox",fieldLabel:_("active"),name:"active",inputValue:1,value:1,checked:true,anchor:"90%",allowBlank:true}]});MODx.window.CreateFCSet.superclass.constructor.call(this,A);};Ext.extend(MODx.window.CreateFCSet,MODx.Window);Ext.reg("modx-window-fc-set-create",MODx.window.CreateFCSet);MODx.window.ImportFCSet=function(A){A=A||{};Ext.applyIf(A,{title:_("import_from_xml"),id:"modx-window-fc-set-import",url:MODx.config.connectors_url+"security/forms/set.php",action:"import",fileUpload:true,saveBtnText:_("import"),fields:[{xtype:"hidden",name:"profile",value:MODx.request.id},{html:_("set_import_msg"),id:"modx-impset-desc",border:false,bodyStyle:"margin: 10px;"},{xtype:"textfield",fieldLabel:_("file"),name:"file",id:"modx-impset-file",anchor:"95%",inputType:"file"}]});MODx.window.ImportFCSet.superclass.constructor.call(this,A);};Ext.extend(MODx.window.ImportFCSet,MODx.Window);Ext.reg("modx-window-fc-set-import",MODx.window.ImportFCSet);